<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AtomForge - FDO Compiler & Decompiler</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'><path d='M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <!-- Minimal App Shell -->
    <header class="topbar">
        <div class="header-left">
            <div class="brand">AtomForge</div>
            <div class="file-menu">
                <button id="fileBtn" class="btn ghost file-btn" aria-haspopup="menu" aria-expanded="false">File</button>
                <menu id="fileMenu" class="menu dropdown-menu" role="menu" hidden>
                    <button role="menuitem" id="saveBtn" data-action="save">
                        Save
                        <span class="menu-shortcut">Ctrl+S</span>
                    </button>
                    <button role="menuitem" id="saveAsBtn" data-action="save-as">
                        Save As...
                    </button>
                    <hr class="menu-divider" />
                    <button role="menuitem" id="openBtn" data-action="open">
                        Open...
                        <span class="menu-shortcut">Ctrl+O</span>
                    </button>
                    <button role="menuitem" id="recentBtn" data-action="recent">
                        Recent Files
                    </button>
                    <hr class="menu-divider" />
                    <button role="menuitem" id="newBtn" data-action="new">
                        New
                        <span class="menu-shortcut">Ctrl+N</span>
                    </button>
                </menu>
            </div>
        </div>
        <nav class="mode-tabs" role="tablist" aria-label="Modes">
            <button role="tab" id="tab-compile" class="tab" data-mode="compile" aria-selected="true" aria-controls="panel-compile">Compile</button>
            <button role="tab" id="tab-decompile" class="tab" data-mode="decompile" aria-selected="false" aria-controls="panel-decompile" tabindex="-1">Decompile</button>
        </nav>
        <div class="actions">
            <div class="examples">
                <button id="examplesBtn" class="btn ghost" aria-haspopup="menu" aria-expanded="false">Examples</button>
                <menu id="examplesMenu" class="menu dropdown-menu" role="menu" hidden>
                    <!-- populated by JS: <button role="menuitem" data-example="basic">Basic Object</button> -->
                </menu>
            </div>
            <button id="apiBtn" class="btn ghost">API</button>
            <button id="runBtn" class="btn primary"><span class="label">Run</span></button>
        </div>
    </header>

    <main class="content">
        <!-- Panels -->
        <section id="panel-compile" class="panel" role="tabpanel" aria-labelledby="tab-compile">
            <textarea id="fdoInput" class="editor" spellcheck="false" placeholder="Enter FDO source…"></textarea>
        </section>

        <section id="panel-decompile" class="panel" role="tabpanel" aria-labelledby="tab-decompile" hidden>
            <div class="decompile-inputs">
                <div class="toggle">
                    <div class="toggle-buttons">
                        <button class="toggle-btn active" data-input="hex">Hex</button>
                        <button class="toggle-btn" data-input="file">File</button>
                    </div>
                    
                </div>

                <div id="fileInputView" class="input-view" hidden>
                    <div class="drop" id="binaryDrop">
                        <span>Drop an FDO binary or JSONL file here or click to choose</span>
                    </div>
                    <input id="binaryFile" type="file" accept=".fdo,.str,.bin,.jsonl" hidden />
                    <button id="openAsHexBtn" class="btn small" hidden>Open as Hex</button>
                </div>

                <div id="hexInputView" class="input-view active">
                    <div class="hex-input-wrapper">
                        <textarea id="hexInput" class="editor mono" spellcheck="false" placeholder="Paste hex data here (auto-detects AOL/P3 frames)"></textarea>
                        <div class="hex-status-line" id="hexStatusLine" hidden role="button" tabindex="-1" aria-disabled="true" aria-label="Extract FDO from detected AOL/P3 frame">
                            <span class="status-icon" id="hexStatusIcon"></span>
                            <span class="status-text" id="hexStatusText">Analyzing hex data...</span>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Status Bar -->
        <div id="statusBar" class="status-bar">
            <div class="status-left">
                <span id="statusOperation" class="status-operation">Untitled</span>
            </div>
            <div class="status-right">
                <span id="statusStats" class="status-stats">0 lines, 0 chars</span>
                <span class="status-separator">|</span>
                <span id="statusMode" class="status-mode">Compile</span>
            </div>
        </div>

        <!-- Content Splitter -->
        <div class="splitter h content-split" role="separator" aria-orientation="horizontal" tabindex="0" aria-label="Resize output"></div>

        <!-- Output -->
        <section class="output">
            <div class="output-tabs" role="tablist" aria-label="Output">
                <button class="tab small" data-tab="status" aria-selected="true">Status</button>
                <button class="tab small" data-tab="hex">Hex</button>
                <button class="tab small" data-tab="source">Source</button>
            </div>
            <div class="output-panels">
                <div id="out-status" class="out-panel" role="tabpanel">
                    <div id="statusLog" class="log">
                    </div>
                </div>
                <div id="out-hex" class="out-panel" role="tabpanel" hidden>
                    <div class="out-toolbar">
                        <div class="left">Binary Output (<span id="compileSize">0 bytes</span>)</div>
                        <div class="right">
                            <button id="downloadBin" class="btn small">Download</button>
                            <button id="copyHex" class="btn small">Copy Hex</button>
                        </div>
                    </div>
                    <pre id="hexView" class="viewer mono"></pre>
                </div>
                <div id="out-source" class="out-panel" role="tabpanel" hidden>
                    <div class="out-toolbar">
                        <div class="left">Source Output (<span id="decompileSize">0 chars</span>)</div>
                        <div class="right">
                            <button id="downloadTxt" class="btn small">Download</button>
                            <button id="copySource" class="btn small">Copy All</button>
                        </div>
                    </div>
                    <pre id="sourceView" class="viewer mono"></pre>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container" aria-live="polite" aria-label="Notifications"></div>

    <!-- API Documentation Modal -->
    <div id="apiModal" class="modal" hidden role="dialog" aria-labelledby="apiModalTitle" aria-modal="true">
        <div class="modal-backdrop" aria-hidden="true"></div>
        <div class="modal-content large">
            <header class="modal-header">
                <h2 id="apiModalTitle">AtomForge API Documentation</h2>
                <button id="apiModalClose" class="btn ghost small" aria-label="Close API documentation">×</button>
            </header>
            <div class="modal-body">
                <!-- Tab Navigation -->
                <nav class="api-tabs" role="tablist">
                    <button class="api-tab active" role="tab" data-tab="quick-start" aria-selected="true">Quick Start</button>
                    <button class="api-tab" role="tab" data-tab="p3-protocol" aria-selected="false">P3 Protocol</button>
                    <button class="api-tab" role="tab" data-tab="reference" aria-selected="false">Reference</button>
                </nav>

                <!-- Tab Content -->
                <div class="api-tab-content">
                    <!-- Quick Start Tab -->
                    <div class="api-tab-panel active" id="tab-quick-start" role="tabpanel">
                        <section class="api-overview">
                            <p>The AtomForge API provides programmatic access to FDO (Field Data Object) compilation and decompilation. Built on a high-performance daemon architecture for low-latency operations.</p>
                            <p><strong>Base URL:</strong> <code class="api-base-url">http://localhost:8000</code></p>
                            <p><strong>Content-Type:</strong> <code>application/json</code> for all requests</p>
                        </section>

                        <section class="api-endpoint">
                            <h3>Compile FDO Source</h3>
                            <div class="endpoint-meta">
                                <span class="method post">POST</span>
                                <code>/compile</code>
                            </div>
                            <p>Compiles FDO source code into optimized binary format.</p>

                            <h4>Request Example</h4>
                            <pre class="code-block"><code>{
  "source": "uni_start_stream &lt;00x&gt;\n  man_start_object &lt;independent, \"Example\"&gt;\n    mat_object_id &lt;example-001&gt;\n  man_end_object &lt;&gt;\nuni_end_stream &lt;&gt;",
  "normalize": true
}</code></pre>

                            <h4>cURL Example</h4>
                            <div class="code-example">
                                <pre class="code-block"><code>curl -X POST http://localhost:8000/compile \
  -H "Content-Type: application/json" \
  -d '{
    "source": "uni_start_stream <00x>\n  man_start_object <independent, \"Example\">\n    mat_object_id <example-001>\n  man_end_object <>\nuni_end_stream <>",
    "normalize": true
  }' \
  --output compiled.fdo</code></pre>
                                <button class="copy-btn" data-copy="compile">Copy</button>
                            </div>

                            <h4>Response</h4>
                            <p><strong>Success:</strong> Binary FDO data • <strong>Error:</strong> JSON with error details</p>
                        </section>

                        <section class="api-endpoint">
                            <h3>Decompile FDO Binary</h3>
                            <div class="endpoint-meta">
                                <span class="method post">POST</span>
                                <code>/decompile</code>
                            </div>
                            <p>Decompiles FDO binary data back to human-readable source code.</p>

                            <h4>Request Example</h4>
                            <pre class="code-block"><code>{
  "binary_data": "UE0xAAABAAAACwAAAHVuaV9zdGFydF9zdHJlYW0gPDAwQj4K...",
  "format": "text"
}</code></pre>

                            <h4>cURL Example</h4>
                            <div class="code-example">
                                <pre class="code-block"><code>curl -X POST http://localhost:8000/decompile \
  -H "Content-Type: application/json" \
  -d '{
    "binary_data": "'$(base64 -i compiled.fdo)'",
    "format": "text"
  }'</code></pre>
                                <button class="copy-btn" data-copy="decompile">Copy</button>
                            </div>

                            <h4>Response Schema</h4>
                            <pre class="code-block"><code>{
  "success": true,
  "source_code": "string",
  "input_size": "number",
  "output_size": "number"
}</code></pre>
                        </section>
                    </div>

                    <!-- P3 Protocol Tab -->
                    <div class="api-tab-panel" id="tab-p3-protocol" role="tabpanel">
                        <section class="api-overview">
                            <p>Advanced P3 protocol functionality for AOL-compatible packet chunking using AOLBUF.AOL emulation logic.</p>
                        </section>

                        <section class="api-endpoint">
                            <h3>Chunk FDO for P3 Protocol</h3>
                            <div class="endpoint-meta">
                                <span class="method post">POST</span>
                                <code>/compile-chunk</code>
                            </div>
                            <p>Compiles and chunks FDO script into P3 protocol payloads using AOLBUF.AOL-compatible segmentation logic. Essential for AOL protocol transmission.</p>

                            <h4>Request Schema</h4>
                            <pre class="code-block"><code>{
  "source": "string",           // FDO script content (required)
  "token": "string",            // 2-byte P3 token: AT, at, f1, ff, DD, D3, OT, XS (optional, default: "AT")
  "stream_id": "number",        // Stream identifier 0-65535 (optional, default: 0)
  "validate_first": "boolean"   // Pre-validate script before chunking (optional, default: true)
}</code></pre>

                            <h4>Supported P3 Tokens</h4>
                            <ul>
                                <li><code>AT</code> - Standard atom token (3-byte stream_id)</li>
                                <li><code>at</code> - Extended atom token (4-byte stream_id)</li>
                                <li><code>f1</code> - Form request (2-byte stream_id)</li>
                                <li><code>ff</code> - Form control (2-byte stream_id)</li>
                                <li><code>DD</code> - Data direct (2-byte stream_id)</li>
                                <li><code>D3</code> - Special data (2-byte stream_id)</li>
                                <li><code>OT</code> - Alert message (2-byte stream_id)</li>
                                <li><code>XS</code> - Force off (2-byte stream_id)</li>
                            </ul>

                            <h4>Request Example</h4>
                            <pre class="code-block"><code>{
  "source": "act_do_action <>\n&lt;\n  sm_send_k1 &lt;8-50934&gt;\n  uni_start_stream &lt;00x&gt;\n    mat_object_id &lt;test-object&gt;\n  uni_end_stream &lt;&gt;\n&gt;",
  "token": "AT",
  "stream_id": 1,
  "validate_first": true
}</code></pre>

                            <h4>cURL Example</h4>
                            <div class="code-example">
                                <pre class="code-block"><code>curl -X POST http://localhost:8000/compile-chunk \
  -H "Content-Type: application/json" \
  -d '{
    "source": "act_do_action <>\n<\n  sm_send_k1 <8-50934>\n  uni_start_stream <00x>\n    mat_object_id <test-object>\n  uni_end_stream <>\n>",
    "token": "AT",
    "stream_id": 1,
    "validate_first": true
  }'</code></pre>
                                <button class="copy-btn" data-copy="chunk">Copy</button>
                            </div>

                            <h4>Response Schema</h4>
                            <pre class="code-block"><code>{
  "success": true,
  "chunks": ["string"],             // Array of base64-encoded P3 payload chunks
  "chunk_count": "number",          // Total number of chunks generated
  "total_size": "number",           // Total bytes across all chunks
  "validation_result": {            // Validation details (if validate_first=true)
    "syntax": {
      "valid": true,
      "errors": [],
      "stats": { "atom_count": 4, "action_blocks": 1 }
    },
    "compilation": {
      "success": true,
      "size": 156
    }
  },
  "stats": {                        // Chunking statistics
    "chunk_count": 2,
    "total_size": 45,
    "average_chunk_size": 22.5,
    "header_size": 5,
    "token": "AT",
    "stream_id": 1
  }
}</code></pre>

                            <h4>Protocol Limits</h4>
                            <ul>
                                <li><strong>Max chunk size:</strong> 119 bytes (including P3 headers)</li>
                                <li><strong>Max segment size:</strong> 255 bytes before segmentation</li>
                                <li><strong>Action blocks:</strong> Preserved as atomic units (never split)</li>
                                <li><strong>Large atoms:</strong> Automatically segmented with continuation markers (0x80)</li>
                            </ul>

                            <h4>Error Response</h4>
                            <pre class="code-block"><code>{
  "success": false,
  "error": "Compilation failed for atom at line 3: Invalid syntax",
  "chunk_count": 0,
  "total_size": 0
}</code></pre>
                        </section>
                    </div>

                    <!-- Reference Tab -->
                    <div class="api-tab-panel" id="tab-reference" role="tabpanel">
                        <section class="api-overview">
                            <p>Utility endpoints for examples, health monitoring, and comprehensive API reference.</p>
                        </section>

                        <section class="api-endpoint">
                            <h3>Get FDO Examples</h3>
                            <div class="endpoint-meta">
                                <span class="method get">GET</span>
                                <code>/examples</code>
                            </div>
                            <p>Retrieves available FDO example scripts from the sample library with optional search filtering.</p>

                            <h4>Query Parameters</h4>
                            <ul>
                                <li><code>search</code> (optional) - Filter examples by content or filename (case-insensitive)</li>
                            </ul>

                            <h4>cURL Example</h4>
                            <div class="code-example">
                                <pre class="code-block"><code>curl "http://localhost:8000/examples?search=object"</code></pre>
                                <button class="copy-btn" data-copy="examples">Copy</button>
                            </div>

                            <h4>Response Schema</h4>
                            <pre class="code-block"><code>[
  {
    "filename": "basic_object.txt",
    "title": "Basic Object Creation",
    "content": "uni_start_stream <00x>\n  man_start_object <independent, \"Example\">\n..."
  }
]</code></pre>
                        </section>

                        <section class="api-endpoint">
                            <h3>Health Check</h3>
                            <div class="endpoint-meta">
                                <span class="method get">GET</span>
                                <code>/health</code>
                            </div>
                            <p>Returns service health status and daemon connectivity information.</p>

                            <h4>Response Schema</h4>
                            <pre class="code-block"><code>{
  "status": "healthy",              // "healthy" or "degraded"
  "service": "atomforge-fdo-api",
  "daemon_status": "running",
  "release_info": {
    "version": "2.0.0",
    "backend_path": "/app/releases/atomforge-backend"
  }
}</code></pre>
                        </section>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <!-- Save Dialog Modal -->
    <div id="saveModal" class="modal" hidden role="dialog" aria-labelledby="saveModalTitle" aria-modal="true">
        <div class="modal-backdrop" aria-hidden="true"></div>
        <div class="modal-content compact">
            <header class="modal-header">
                <h2 id="saveModalTitle">Save Script</h2>
                <button id="saveModalClose" class="btn ghost small" aria-label="Close save dialog">×</button>
            </header>
            <div class="modal-body">
                <form id="saveForm" class="save-form">
                    <div class="form-group">
                        <label for="scriptName" class="form-label">Script Name</label>
                        <input
                            type="text"
                            id="scriptName"
                            class="form-input"
                            placeholder="Enter script name..."
                            maxlength="100"
                            required
                        />
                        <div class="form-help">
                            Choose a descriptive name for your script (max 100 characters)
                        </div>

                        <!-- Save Status Indicator -->
                        <div id="saveStatus" class="save-status" hidden>
                            <div class="status-icon"></div>
                            <div class="status-message"></div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="saveCancelBtn" class="btn ghost">Cancel</button>
                        <button type="submit" id="saveConfirmBtn" class="btn primary" disabled>
                            <span class="btn-text">Save</span>
                            <span class="btn-spinner" hidden>
                                <svg class="spinner" width="16" height="16" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="31.416" stroke-dashoffset="31.416">
                                        <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
                                        <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
                                    </circle>
                                </svg>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- File Browser Modal -->
    <div id="fileBrowserModal" class="modal" hidden role="dialog" aria-labelledby="fileBrowserModalTitle" aria-modal="true">
        <div class="modal-backdrop" aria-hidden="true"></div>
        <div class="modal-content large">
            <header class="modal-header">
                <h2 id="fileBrowserModalTitle">Open Script</h2>
                <button id="fileBrowserModalClose" class="btn ghost small" aria-label="Close file browser">×</button>
            </header>
            <div class="modal-body">
                <div class="file-browser">
                    <div class="file-browser-toolbar">
                        <div class="search-wrapper">
                            <span class="search-icon"></span>
                            <input
                                type="text"
                                id="fileSearchInput"
                                class="search-input"
                                placeholder="Search scripts..."
                                autocomplete="off"
                                spellcheck="false"
                            />
                            <button id="fileSearchClear" class="search-clear" type="button" hidden>×</button>
                        </div>
                        <div class="file-filters">
                            <button id="showAllFiles" class="filter-btn active" data-filter="all">All</button>
                            <button id="showFavorites" class="filter-btn" data-filter="favorites">Favorites</button>
                            <button id="showRecent" class="filter-btn" data-filter="recent">Recent</button>
                        </div>
                    </div>

                    <div id="fileLoadingIndicator" class="loading-indicator" hidden>
                        <span>Loading scripts...</span>
                    </div>

                    <div id="fileNoResults" class="no-results" hidden>
                        <span>No scripts found</span>
                    </div>

                    <div class="file-list-container">
                        <div class="file-list-header">
                            <div class="file-name-header">Name</div>
                            <div class="file-size-header">Size</div>
                            <div class="file-date-header">Modified</div>
                            <div class="file-actions-header">Actions</div>
                        </div>
                        <div id="fileList" class="file-list">
                            <!-- File rows will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmModal" class="modal" hidden role="dialog" aria-labelledby="confirmModalTitle" aria-modal="true">
        <div class="modal-backdrop" aria-hidden="true"></div>
        <div class="modal-content mini">
            <header class="modal-header">
                <h2 id="confirmModalTitle">Confirm Action</h2>
                <button id="confirmModalClose" class="btn ghost small" aria-label="Close confirmation">×</button>
            </header>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure you want to continue?</p>
                <div class="form-actions">
                    <button type="button" id="confirmCancelBtn" class="btn ghost">Cancel</button>
                    <button type="button" id="confirmOkBtn" class="btn primary">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container" aria-live="polite"></div>


    <!-- Scripts -->
    <script src="/script.js?v=2025-09-26-search"></script>
</body>
</html>